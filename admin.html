<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - AcademiX</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link rel="stylesheet" href="./styles.css" />
</head>

<body>
  <div class="app">
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <img src="10003.png" alt="AcademiX" class="brand-logo" />
        <div class="name">
          <span class="title">AcademiX</span>
        </div>
      </div>

      <div class="nav-section">
        <div class="nav-heading">Main</div>
        <a class="nav-link active" href="#" data-view="students">
          <span class="nav-left">üë• Students</span>
        </a>
        <a class="nav-link" href="#" data-view="add-student">
          <span class="nav-left">‚ûï Add Student</span>
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-heading">Academics</div>
        <a class="nav-link" href="#" data-view="courses">
          <span class="nav-left">üìö Course Management</span>
        </a>
        <a class="nav-link" href="#" data-view="results">
          <span class="nav-left">üìä Results Management</span>
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-heading">Finance</div>
        <a class="nav-link" href="#" data-view="finance">
          <span class="nav-left">üí≥ Fee Management</span>
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-heading">Settings</div>
        <a class="nav-link" href="#" data-view="settings">
          <span class="nav-left">‚öôÔ∏è Admin Settings</span>
        </a>
      </div>

      <div class="nav-section">
        <a class="nav-link" href="#" id="adminLogout">
          <span class="nav-left">üö™ Sign out</span>
        </a>
      </div>

      <div class="sidebar-footer">
        <div>Admin Panel</div>
        <div>Eden University</div>
      </div>
    </aside>

    <div>
      <header class="topbar">
        <div style="display: flex; align-items: center;">
          <button class="hamburger-btn" id="sidebarToggle">
            <span class="material-icons">menu</span>
          </button>
          <div class="breadcrumb">
            <span>Admin</span> / <strong id="currentView">Students</strong>
          </div>
        </div>
        <div class="top-actions">
          <button class="icon-btn" aria-label="Notifications">üîî</button>
          <div class="avatar-pill-dropdown">
            <button type="button" class="avatar-pill">
              <span class="status-dot"></span>
              <span>Admin ‚ñæ</span>
            </button>
          </div>
        </div>
      </header>

      <main class="content">
        <!-- Students List View -->
        <div id="students-view" class="admin-view visible">
          <div class="page-head">
            <div class="page-title">
              <h1>Student Management</h1>
              <p class="sub">Manage all student accounts and information</p>
            </div>
            <button class="btn-primary" onclick="showView('add-student')">
              <span class="material-icons">add</span>
              Add New Student
            </button>
          </div>

          <div class="students-table-container">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Student ID</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Program</th>
                  <th>Year</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="studentsTableBody">
                <!-- Students will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Add/Edit Student View -->
        <div id="add-student-view" class="admin-view">
          <div class="page-head">
            <div class="page-title">
              <h1 id="studentFormTitle">Add New Student</h1>
              <p class="sub">Enter student information to create a new account</p>
            </div>
            <button class="btn-ghost" onclick="showView('students')">
              <span class="material-icons">arrow_back</span>
              Back to Students
            </button>
          </div>

          <form id="studentForm" class="admin-form">
            <input type="hidden" id="studentId" name="studentId" />

            <div class="form-section">
              <h2>Personal Information</h2>
              <div class="form-grid">
                <div class="form-group">
                  <label for="fullName">Full Name *</label>
                  <input type="text" id="fullName" name="fullName" required />
                </div>
                <div class="form-group">
                  <label for="email">Email Address *</label>
                  <input type="email" id="email" name="email" required />
                </div>
                <div class="form-group">
                  <label for="phone">Phone Number</label>
                  <input type="tel" id="phone" name="phone" />
                </div>
                <div class="form-group">
                  <label for="studentIdInput">Student ID *</label>
                  <input type="text" id="studentIdInput" name="studentIdInput" required />
                </div>
              </div>
            </div>

            <div class="form-section">
              <h2>Academic Information</h2>
              <div class="form-grid">
                <div class="form-group">
                  <label for="school">School *</label>
                  <input type="text" id="school" name="school" required
                    placeholder="e.g., School of Education, Humanities and Social Sciences" />
                </div>
                <div class="form-group">
                  <label for="program">Program *</label>
                  <input type="text" id="program" name="program" required
                    placeholder="e.g., Bachelor of Science in ICT" />
                </div>
                <div class="form-group">
                  <label for="year">Year *</label>
                  <select id="year" name="year" required>
                    <option value="">Select Year</option>
                    <option value="1">Year 1</option>
                    <option value="2">Year 2</option>
                    <option value="3">Year 3</option>
                    <option value="4">Year 4</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="academicSession">Academic Session *</label>
                  <input type="text" id="academicSession" name="academicSession" required
                    placeholder="e.g., GER 2025" />
                </div>
                <div class="form-group">
                  <label for="registrationStatus">Registration Status *</label>
                  <select id="registrationStatus" name="registrationStatus" required>
                    <option value="Registered">Registered</option>
                    <option value="Not Registered">Not Registered</option>
                    <option value="Pending">Pending</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="courses">Courses (comma separated)</label>
                  <textarea id="courses" name="courses" rows="3"
                    placeholder="e.g., Mathematics, Physics, Chemistry"></textarea>
                </div>
              </div>
            </div>

            <div class="form-section">
              <h2>Additional Information</h2>
              <div class="form-grid">
                <div class="form-group">
                  <label for="studentSponsor">Student Sponsor</label>
                  <input type="text" id="studentSponsor" name="studentSponsor" placeholder="e.g., SELF" />
                </div>
                <div class="form-group">
                  <label for="accommodation">Accommodation</label>
                  <select id="accommodation" name="accommodation">
                    <option value="NON-RESIDENT">NON-RESIDENT</option>
                    <option value="RESIDENT">RESIDENT</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="remark">Remark</label>
                  <textarea id="remark" name="remark" rows="2" placeholder="e.g., NO COMMENT ADDED YET"></textarea>
                </div>
              </div>
            </div>

            <div class="form-section">
              <h2>Account Settings</h2>
              <div class="form-grid">
                <div class="form-group">
                  <label for="password">Password *</label>
                  <input type="password" id="password" name="password" required />
                </div>
                <div class="form-group">
                  <label for="confirmPassword">Confirm Password *</label>
                  <input type="password" id="confirmPassword" name="confirmPassword" required />
                </div>
                <div class="form-group">
                  <label for="profilePhoto">Profile Photo</label>
                  <input type="file" id="profilePhoto" name="profilePhoto" accept="image/*" />
                  <small>Upload student profile picture</small>
                </div>
              </div>
            </div>

            <div class="form-section">
              <h2>Results</h2>
              <div id="resultsContainer">
                <div class="result-entry">
                  <div class="form-grid">
                    <div class="form-group">
                      <label>Course Code</label>
                      <input type="text" class="result-code" placeholder="e.g., ICT101" />
                    </div>
                    <div class="form-group">
                      <label>Course</label>
                      <input type="text" class="result-course" placeholder="Course name" />
                    </div>
                    <div class="form-group">
                      <label>Grade</label>
                      <input type="text" class="result-grade" placeholder="e.g., A, B, C" />
                    </div>
                    <div class="form-group">
                      <label>&nbsp;</label>
                      <button type="button" class="btn-ghost remove-result">Remove</button>
                    </div>
                  </div>
                </div>
              </div>
              <button type="button" class="btn-ghost" onclick="addResultEntry()">
                <span class="material-icons">add</span>
                Add Result
              </button>
            </div>

            <div class="form-actions">
              <button type="button" class="btn-ghost" onclick="showView('students')">Cancel</button>
              <button type="submit" class="btn-primary">Save Student</button>
            </div>
          </form>
        </div>

        <!-- Settings View -->
        <div id="settings-view" class="admin-view">
          <div class="page-head">
            <div class="page-title">
              <h1>Admin Settings</h1>
              <p class="sub">Manage admin account settings</p>
            </div>
          </div>

          <div class="settings-section">
            <h2>Change Admin Password</h2>
            <form id="adminPasswordForm" class="admin-form">
              <div class="form-grid">
                <div class="form-group">
                  <label for="currentPassword">Current Password</label>
                  <input type="password" id="currentPassword" required />
                </div>
                <div class="form-group">
                  <label for="newPassword">New Password</label>
                  <input type="password" id="newPassword" required />
                </div>
                <div class="form-group">
                  <label for="confirmNewPassword">Confirm New Password</label>
                  <input type="password" id="confirmNewPassword" required />
                </div>
              </div>
              <button type="submit" class="btn-primary">Update Password</button>
            </form>
          </div>
        </div>

        <!-- Course Management View -->
        <div id="courses-view" class="admin-view">
          <div class="page-head">
            <div class="page-title">
              <h1>Course Management</h1>
              <p class="sub">Manage all courses and course assignments</p>
            </div>
            <button class="btn-primary" onclick="showAddCourseForm()">
              <span class="material-icons">add</span>
              Add New Course
            </button>
          </div>

          <div class="students-table-container">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Course Code</th>
                  <th>Course Name</th>
                  <th>Program</th>
                  <th>Year</th>
                  <th>Credits</th>
                  <th>Students Enrolled</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="coursesTableBody">
                <!-- Courses will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Results Management View -->
        <div id="results-view" class="admin-view">
          <div class="page-head">
            <div class="page-title">
              <h1>Results Management</h1>
              <p class="sub">View and manage student academic results</p>
            </div>
          </div>

          <div class="form-section" style="margin-bottom: 24px;">
            <div class="form-grid">
              <div class="form-group">
                <label for="resultStudentSelect">Select Student</label>
                <select id="resultStudentSelect" onchange="loadStudentResults()">
                  <option value="">-- Select Student --</option>
                </select>
              </div>
              <div class="form-group">
                <label for="resultCourseSelect">Select Course</label>
                <select id="resultCourseSelect">
                  <option value="">-- Select Course --</option>
                </select>
              </div>
              <div class="form-group">
                <label for="resultAcademicYear">Academic Year</label>
                <select id="resultAcademicYear">
                  <option value="2025">2025</option>
                  <option value="2024">2024</option>
                  <option value="2023">2023</option>
                </select>
              </div>
            </div>
          </div>

          <div id="studentResultsContainer">
            <div class="empty-state" style="text-align: center; padding: 40px; color: var(--muted);">
              <p>Select a student to view their results</p>
            </div>
          </div>
        </div>

        <!-- Finance Management View -->
        <div id="finance-view" class="admin-view">
          <div class="page-head">
            <div class="page-title">
              <h1>Fee Management</h1>
              <p class="sub">Manage student fees and payments</p>
            </div>
          </div>

          <div class="form-section" style="margin-bottom: 24px;">
            <div class="form-grid">
              <div class="form-group">
                <label for="financeStudentSelect">Select Student</label>
                <select id="financeStudentSelect" onchange="loadStudentFinance()">
                  <option value="">-- Select Student --</option>
                </select>
              </div>
              <div class="form-group">
                <label for="financeAcademicYear">Academic Year</label>
                <select id="financeAcademicYear">
                  <option value="2025-2026">2025 - 2026</option>
                  <option value="2024-2025">2024 - 2025</option>
                </select>
              </div>
            </div>
          </div>

          <div id="studentFinanceContainer">
            <div class="empty-state" style="text-align: center; padding: 40px; color: var(--muted);">
              <p>Select a student to manage their fees</p>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="admin_data.js"></script>
  <script src="utils.js"></script>
  <script>
    // FALLBACK: Essential admin functions if admin_data.js is blocked
    if (typeof isAdminLoggedIn !== 'function') {
      console.warn('admin_data.js not loaded. Using internal admin fallback.');

      const FB_URL = 'https://uqeifgszsqtfcuscrexd.supabase.co';
      const FB_KEY = 'sb_publishable_KO9_5LwsUO2tCYQsMKC8iA_Ur3Rj1SO';

      let fb_supabase = null;
      try {
        if (window.supabase) fb_supabase = window.supabase.createClient(FB_URL, FB_KEY);
      } catch (e) { console.error('Fallback Supabase init failed', e); }

      window.isAdminLoggedIn = function () {
        return sessionStorage.getItem('adminLoggedIn') === 'true';
      };
      window.logoutAdmin = function () {
        sessionStorage.removeItem('adminLoggedIn');
      };

      // Data Management Fallbacks
      window.getAllStudents = async function () {
        if (!fb_supabase) return [];
        try {
          const { data, error } = await fb_supabase.from('students').select('*').order('fullName', { ascending: true });
          return error ? [] : data;
        } catch (e) { return []; }
      };

      window.getStudentById = async function (id) {
        if (!fb_supabase) return null;
        try {
          const { data, error } = await fb_supabase.from('students').select('*').eq('id', id).single();
          return error ? null : data;
        } catch (e) { return null; }
      };

      window.addStudent = async function (studentData) {
        if (!fb_supabase) throw new Error('Supabase client not available');
        const { data, error } = await fb_supabase.from('students').insert([{
          ...studentData, accountStatus: 'active', createdAt: new Date().toISOString()
        }]).select();
        if (error) throw error;
        return data[0];
      };

      window.updateStudent = async function (id, updatedData) {
        if (!fb_supabase) throw new Error('Supabase client not available');
        const { data, error } = await fb_supabase.from('students').update(updatedData).eq('id', id).select();
        if (error) throw error;
        return data[0];
      };

      window.deleteStudent = async function (id) {
        if (!fb_supabase) throw new Error('Supabase client not available');
        const { error } = await fb_supabase.from('students').delete().eq('id', id);
        if (error) throw error;
        return { success: true };
      };

      window.getAdminAccount = async function () {
        if (!fb_supabase) return { username: 'Administrator', password: '#Sean@7053' };
        try {
          const { data, error } = await fb_supabase.from('admin_settings').select('*').limit(1).single();
          if (error) return { username: 'Administrator', password: '#Sean@7053' };
          return data;
        } catch (e) { return { username: 'Administrator', password: '#Sean@7053' }; }
      };

      window.updateAdminAccount = async function (newAdminData) {
        if (!fb_supabase) throw new Error('Supabase client not available');
        // Simple upsert logic
        const { data: existing } = await fb_supabase.from('admin_settings').select('id').limit(1).maybeSingle();
        if (existing) {
          await fb_supabase.from('admin_settings').update(newAdminData).eq('id', existing.id);
        } else {
          await fb_supabase.from('admin_settings').insert([newAdminData]);
        }
        return { success: true };
      };
    }
  </script>
  <script src="admin_script.js"></script>
</body>

</html>